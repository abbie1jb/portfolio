<!DOCTYPE HTML>
<!--
	Prologue by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Prologue by HTML5 UP</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
	</head>
	<body class="is-preload">

		<!-- Header -->
			<div id="header">

				<div class="top">

					<!-- Logo -->
						<div id="logo">
							<span class="image avatar48"><img src="bam.jpg" alt="" /></span>
							<h1 id="title">Abbie Bambrough</h1>
							<p>Product Design</p>
						</div>

					<!-- Nav -->
						<nav id="nav">
							<ul>
								<li><a href="#top" id="top-link"><span class="icon solid fa-home">Intro</span></a></li>
								<li><a href="#portfolio" id="portfolio-link"><span class="icon solid fa-th">Portfolio</span></a></li>
								<li><a href="#about" id="about-link"><span class="icon solid fa-user">About Me</span></a></li>
								<li><a href="#contact" id="contact-link"><span class="icon solid fa-envelope">Contact</span></a></li>
							</ul>
						</nav>

				</div>

				<div class="bottom">

					<!-- Social Icons -->
						<ul class="icons">
							<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
							<li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
							<li><a href="#" class="icon brands fa-github"><span class="label">Github</span></a></li>
							<li><a href="#" class="icon brands fa-dribbble"><span class="label">Dribbble</span></a></li>
							<li><a href="#" class="icon solid fa-envelope"><span class="label">Email</span></a></li>
						</ul>

				</div>

			</div>

		<!-- Main -->
			<div id="main">

				<!-- Intro -->
					<section id="top" class="one dark cover">
						<div class="container">

							<header>
								<h2 class="alt">Hi! I'm <strong>Prologue</strong>, a <a href="http://html5up.net/license">free</a> responsive<br />
								site template designed by <a href="http://html5up.net">HTML5 UP</a>.</h2>
								<p>Ligula scelerisque justo sem accumsan diam quis<br />
								vitae natoque dictum sollicitudin elementum.</p>
							</header>

							<footer>
								<a href="#portfolio" class="button scrolly">See my work</a>
							</footer>

						</div>
					</section>

				<!-- Portfolio -->
					<section id="portfolio" class="two">
						<div class="container">

							<header>
								<h2>Portfolio</h2>
							</header>

							<p>Vitae natoque dictum etiam semper magnis enim feugiat convallis convallis
							egestas rhoncus ridiculus in quis risus amet curabitur tempor orci penatibus.
							Tellus erat mauris ipsum fermentum etiam vivamus eget. Nunc nibh morbi quis
							fusce hendrerit lacus ridiculus.</p>

							<div class="row" id="work-display-container"></div>

						</div>
					</section>

				<!-- About Me -->
					<section id="about" class="three">
						<div class="container">

							<header>
								<h2>About Me</h2>
							</header>

							<a href="#" class="image featured"><img src="about.jpg" alt="" /></a>

							<p>Tincidunt eu elit diam magnis pretium accumsan etiam id urna. Ridiculus
							ultricies curae quis et rhoncus velit. Lobortis elementum aliquet nec vitae
							laoreet eget cubilia quam non etiam odio tincidunt montes. Elementum sem
							parturient nulla quam placerat viverra mauris non cum elit tempus ullamcorper
							dolor. Libero rutrum ut lacinia donec curae mus vel quisque sociis nec
							ornare iaculis.</p>

						</div>
					</section>

				<!-- Contact -->
					<section id="contact" class="four">
						<div class="container">

							<header>
								<h2>Contact</h2>
							</header>

							<p>Elementum sem parturient nulla quam placerat viverra
							mauris non cum elit tempus ullamcorper dolor. Libero rutrum ut lacinia
							donec curae mus. Eleifend id porttitor ac ultricies lobortis sem nunc
							orci ridiculus faucibus a consectetur. Porttitor curae mauris urna mi dolor.</p>

							<form method="post" action="#">
								<div class="row">
									<div class="col-6 col-12-mobile"><input type="text" name="name" placeholder="Name" /></div>
									<div class="col-6 col-12-mobile"><input type="text" name="email" placeholder="Email" /></div>
									<div class="col-12">
										<textarea name="message" placeholder="Message"></textarea>
									</div>
									<div class="col-12">
										<input type="submit" value="Send Message" />
									</div>
								</div>
							</form>

						</div>
					</section>

			</div>

		<!-- Footer -->
			<div id="footer">

				<!-- Copyright -->
					<ul class="copyright">
						<li>&copy; Untitled. All rights reserved.</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
					</ul>

			</div>

		<!-- Scripts -->
			<script>
				// Capture detailed errors and unhandled promise rejections to help debugging.
				window.addEventListener('error', function (e) {
					try {
						console.error('Captured error:', e.message, e.filename + ':' + e.lineno + ':' + e.colno);
						if (e.error && e.error.stack) console.error('Stack:', e.error.stack);
					} catch (err) {
						console.error('Error while reporting error:', err);
					}
				});
				window.addEventListener('unhandledrejection', function (e) {
					try {
						console.error('Unhandled rejection:', e.reason && (e.reason.stack || e.reason));
					} catch (err) {
						console.error('Error while reporting rejection:', err);
					}
				});
			</script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" crossorigin="anonymous"></script>
			<script type="module">
				// Import the example ES module versions and attach them to THREE so legacy non-module code
				// (assets/js/3d-viewer.js) can use `new THREE.GLTFLoader()` and `new THREE.OrbitControls(...)`.
				// Use jsDelivr GH path (specific commit/tag) to avoid 404s.
				import { GLTFLoader } from 'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/jsm/loaders/GLTFLoader.js';
				import { OrbitControls } from 'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/jsm/controls/OrbitControls.js';
				// Ensure THREE exists and expose the classes on it.
				window.THREE = window.THREE || THREE;
				THREE.GLTFLoader = GLTFLoader;
				THREE.OrbitControls = OrbitControls;
				console.debug('Attached GLTFLoader and OrbitControls from jsm modules to THREE (jsdelivr GH)');
			</script>
			<script src="assets/js/3d-viewer.js"></script>
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/jquery.scrollex.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			<script>
				// Debug initialization: check that required globals exist and capture any errors.
				document.addEventListener('DOMContentLoaded', function() {
					try {
						console.log('Debug: window.THREE =', !!window.THREE);
						console.log('Debug: THREE.GLTFLoader =', !!(window.THREE && window.THREE.GLTFLoader));
						console.log('Debug: THREE.OrbitControls =', !!(window.THREE && window.THREE.OrbitControls));
						console.log('Debug: CADViewer defined =', !!window.CADViewer);
						
						// Try constructing the loader to force any constructor-related errors to surface with stack.
						if (window.THREE && window.THREE.GLTFLoader) {
							try {
								console.log('Attempting to construct GLTFLoader...');
								var _testLoader = new THREE.GLTFLoader();
								console.log('GLTFLoader constructed successfully');
							} catch (err) {
								console.error('Error constructing GLTFLoader:', err && err.stack ? err.stack : err);
							}
						}
						
						// Only initialize the viewer if CADViewer is present.
						if (!window.CADViewer) {
							throw new Error('CADViewer class is not available.');
						}
						
						try {
							// Dynamically create one viewer per WORK_DISPLAY manifest item
							(function() {
								var container = document.getElementById('work-display-container');
								if (!container) {
									console.warn('work-display-container not found; skipping dynamic viewers.');
									return;
								}
								
								// Load manifest (generated in WORK_DISPLAY/manifest.json)
								// Fallback behaviour: if manifest.json is missing, attempt to scan the WORK_DISPLAY directory
								// for subfolders and try to locate a .gltf model (works when the server exposes directory listings).
								(function() {
									var container = document.getElementById('work-display-container');
									if (!container) {
										console.warn('work-display-container not found; skipping dynamic viewers.');
										return;
									}
									
									function createViewerElement(name, modelUrl, idx) {
										var col = document.createElement('div');
										col.className = 'col-4 col-12-mobile';
										
										var article = document.createElement('article');
										article.className = 'item';
										
										var viewerDiv = document.createElement('div');
										var id = 'work-cad-' + idx;
										viewerDiv.id = id;
										viewerDiv.style.height = '300px';
										viewerDiv.style.width = '100%';
										viewerDiv.style.border = '1px solid #ddd';
										viewerDiv.style.borderRadius = '4px';
										viewerDiv.style.overflow = 'hidden';
										
										article.appendChild(viewerDiv);
										
										var header = document.createElement('header');
										var h3 = document.createElement('h3');
										h3.textContent = name || ('Item ' + (idx + 1));
										header.appendChild(h3);
										article.appendChild(header);
										
										col.appendChild(article);
										container.appendChild(col);
										
										try {
											new CADViewer(id, modelUrl);
											console.log('CADViewer initialized for', name, modelUrl);
											
											// Make the portfolio item clickable
											article.style.cursor = 'pointer';
											article.addEventListener('click', function() {
												window.location.href = 'detail.html?project=' + encodeURIComponent(name);
											});
										} catch (e) {
											console.error('Failed to initialize CADViewer for', name, e);
										}
									}
									
									function tryLoadManifest() {
										return fetch('WORK_DISPLAY/manifest.json').then(function(res) {
											if (!res.ok) throw new Error('Manifest fetch failed: ' + res.status);
											return res.json();
										}).then(function(manifest) {
											if (!manifest || !Array.isArray(manifest.items)) {
												throw new Error('No items in manifest');
											}
											manifest.items.forEach(function(item, idx) {
												createViewerElement(item.name, item.model, idx);
											});
										});
									}
									
									// Parse an HTML directory listing and return folder hrefs (that end with '/')
									function parseDirectoryListing(html) {
										var parser = new DOMParser();
										var doc = parser.parseFromString(html, 'text/html');
										var anchors = Array.from(doc.querySelectorAll('a[href]'));
										return anchors.map(function(a) { return a.getAttribute('href'); })
											.filter(function(h) { return h && h.endsWith('/'); })
											.filter(function(h) { return h !== '../'; });
									}
									
									// Recursively look for a .gltf file inside a directory by parsing directory listings.
									function findGltfInPath(basePath) {
										// Try to fetch the path and parse for .gltf links or subfolders.
										return fetch(basePath).then(function(res) {
											if (!res.ok) return null;
											return res.text();
										}).then(function(text) {
											if (!text) return null;
											var hrefs = parseDirectoryListing(text);
											// Look for any direct .gltf links first
											var gltfMatch = text.match(/href=["']([^"']+\.gltf)["']/i);
											if (gltfMatch) {
												var candidate = gltfMatch[1];
												// If candidate is relative, prefix basePath
												if (/^https?:|^\//i.test(candidate)) return candidate;
												return basePath + candidate;
											}
											// Otherwise walk subfolders (first-level) and try to find .gltf there
											var promises = hrefs.map(function(h) {
												var nextPath = basePath + h;
												// Try to find gltf in nextPath (may recurse)
												return findGltfInPath(nextPath).catch(function() { return null; });
											});
											return Promise.all(promises).then(function(results) {
												for (var i = 0; i < results.length; i++) {
													if (results[i]) return results[i];
												}
												return null;
											});
										}).catch(function() {
											return null;
										});
									}
									
									function scanWorkDisplay() {
										return fetch('WORK_DISPLAY/').then(function(res) {
											if (!res.ok) throw new Error('WORK_DISPLAY directory fetch failed: ' + res.status);
											return res.text();
										}).then(function(html) {
											var folders = parseDirectoryListing(html);
											if (!folders || folders.length === 0) {
												throw new Error('No folders found in WORK_DISPLAY directory listing');
											}
											var counter = 0;
											var tasks = folders.map(function(folderHref) {
												var folderPath = 'WORK_DISPLAY/' + folderHref;
												// First try common CAD_MODEL location
												return findGltfInPath(folderPath + 'CAD_MODEL/').then(function(gltfUrl) {
													if (!gltfUrl) {
														// As a fallback, try to find any .gltf under the folder root
														return findGltfInPath(folderPath).then(function(gltfUrl2) {
															if (!gltfUrl2) {
																console.warn('No .gltf found in', folderPath);
																return null;
															}
															return { name: folderHref.replace(/\/$/, ''), model: gltfUrl2 };
														});
													}
													return { name: folderHref.replace(/\/$/, ''), model: gltfUrl };
												}).then(function(result) {
													if (result) {
														createViewerElement(result.name, result.model, counter++);
													}
												}).catch(function(err) {
													console.warn('Error scanning folder', folderPath, err);
												});
											});
											return Promise.all(tasks);
										});
									}
									
									// Try manifest first, then fallback to scanning WORK_DISPLAY directory when manifest is absent.
									tryLoadManifest().catch(function(manifestErr) {
										console.warn('Manifest load failed, attempting directory scan:', manifestErr);
										return scanWorkDisplay();
									}).catch(function(err) {
										console.error('Failed to load WORK_DISPLAY items (manifest + scan):', err);
									});
								})();
							})();
						} catch (err) {
							console.error('Error initializing CADViewer:', err && err.stack ? err.stack : err);
						}
					} catch (e) {
						console.error('Fatal error during DOMContentLoaded debug init:', e && e.stack ? e.stack : e);
					}
				});
			</script>

	</body>
</html>
